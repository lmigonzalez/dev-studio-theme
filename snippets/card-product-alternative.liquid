{% comment %}
  Renders an improved product card with enhanced styling and direct add to cart functionality

  Accepts:
  - card_product: {Object} Product Liquid object (optional)
  - media_aspect_ratio: {String} Size of the product image card. Values are "square" and "portrait". Default is "square" (optional)
  - show_vendor: {Boolean} Show the product vendor. Default: false
  - show_rating: {Boolean} Show the product rating. Default: false
  - lazy_load: {Boolean} Image should be lazy loaded. Default: true (optional)
  - skip_styles: {Boolean} Don't include component styles. Useful when rendering multiple product cards in a loop. Default: false (optional)
  - section_id: {String} The ID of the section that contains this card.
  - placeholder_image: {String} The placeholder image to use when no product exists. Default: 'product-apparel-2' (optional)

  Usage:
  {% render 'card-product-alternative', show_vendor: section.settings.show_vendor %}
{% endcomment %}

{%- unless skip_styles -%}
  {{ 'component-rating.css' | asset_url | stylesheet_tag }}
  {{ 'component-price.css' | asset_url | stylesheet_tag }}
  <style>
    .card-alternative {
      position: relative;
      background: #ffffff;
      border-radius: {{ settings.alternative_card_border_radius | default: 16 }}px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      overflow: hidden;
      border: 1px solid rgba(0, 0, 0, 0.06);
    }

    .card-alternative:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .card-alternative__media {
      position: relative;
      overflow: hidden;
      border-radius: {{ settings.alternative_card_border_radius | default: 16 }}px {{ settings.alternative_card_border_radius | default: 16 }}px 0 0;
      background: #f8f9fa;
    }

    .card-alternative__media img {
      width: 100%;
      height: 220px;
      object-fit: cover;
      transition: transform 0.4s ease;
    }

    .card-alternative:hover .card-alternative__media img {
      transform: scale(1.05);
    }

    .card-alternative__overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      transition: opacity 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .card-alternative:hover .card-alternative__overlay {
      opacity: 1;
    }

    .card-alternative__eye-icon {
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .card-alternative__eye-icon svg {
      width: 28px;
      height: 28px;
      fill: #2c3e50;
      transition: fill 0.3s ease;
    }

    .card-alternative__overlay:hover .card-alternative__eye-icon {
      transform: scale(1.1);
      background: white;
    }

    .card-alternative__overlay:hover .card-alternative__eye-icon svg {
      fill: #3498db;
    }

    .card-alternative__badge {
      position: absolute;
      top: 12px;
      left: 12px;
      background: {{ settings.alternative_card_badge_color | default: '#ff4757' }};
      color: white;
      padding: 6px 12px;
      border-radius: {{ settings.alternative_card_badge_border_radius | default: 20 }}px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      z-index: 2;
    }

    .card-alternative__badge--sale {
      background: {{ settings.alternative_card_badge_color | default: '#ff4757' }};
    }

    .card-alternative__badge--sold-out {
      background: #6c757d;
    }

    .card-alternative__content {
      padding: 8px;
    }

    .card-alternative__vendor {
      font-size: 12px;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .card-alternative__title {
      font-size: 16px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 8px;
      line-height: 1.3;
      height: calc(1.3em * 2); /* Fixed height for exactly 2 lines */
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-decoration: none;
    }

    .card-alternative__title:hover {
      color: #3498db;
      text-decoration: none;
    }

    .card-alternative__rating {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 10px;
    }

    .card-alternative__stars {
      color: #ffc107;
      font-size: 14px;
    }

    .card-alternative__rating-text {
      font-size: 12px;
      color: #6c757d;
    }

    .card-alternative__price {
      margin-bottom: 14px;
    }

    .card-alternative__price-current {
      font-size: 18px;
      font-weight: 700;
      color: #2c3e50;
    }

    .card-alternative__price-compare {
      font-size: 16px;
      color: #6c757d;
      text-decoration: line-through;
      margin-left: 8px;
    }

    .card-alternative__add-to-cart {
      width: 100%;
      background: {{ settings.alternative_card_button_color | default: '#3498db' }};
      color: {{ settings.alternative_card_button_text_color | default: 'white' }};
      border: none;
      padding: 10px 16px;
      border-radius: {{ settings.alternative_card_button_border_radius | default: 8 }}px;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .card-alternative__add-to-cart:hover {
      background: {{ settings.alternative_card_button_hover_color | default: '#2980b9' }};
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba({{ settings.alternative_card_button_color | default: '#3498db' | remove: '#' | prepend: '52, 152, 219' }}, 0.3);
    }

    .card-alternative__add-to-cart:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .card-alternative__add-to-cart .loading-spinner {
      display: none;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }

    .card-alternative__add-to-cart.loading .loading-spinner {
      display: inline-block;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .card-alternative__content {
        padding: 16px;
      }

      .card-alternative__media img {
        height: 180px;
      }

      .card-alternative__title {
        font-size: 15px;
      }

      .card-alternative__price-current {
        font-size: 16px;
      }

      .card-alternative__add-to-cart {
        padding: 8px 12px;
        font-size: 12px;
      }
    }
  </style>
{%- endunless -%}

{%- if card_product and card_product != empty -%}
  {%- liquid
    assign ratio = 1
    if card_product.featured_media and media_aspect_ratio == 'portrait'
      assign ratio = 0.8
    elsif card_product.featured_media and media_aspect_ratio == 'adapt'
      assign ratio = card_product.featured_media.aspect_ratio
    endif
    if ratio == 0 or ratio == null
      assign ratio = 1
    endif
  -%}

  <div class="card-wrapper product-card-wrapper">
    <div class="card-alternative">
      <!-- Product Image -->
      <div class="card-alternative__media">
        {%- if card_product.featured_media -%}
          {% comment %}theme-check-disable ImgLazyLoading{% endcomment %}
          <img
            srcset="
              {%- if card_product.featured_media.width >= 165 -%}{{ card_product.featured_media | image_url: width: 165 }} 165w,{%- endif -%}
              {%- if card_product.featured_media.width >= 360 -%}{{ card_product.featured_media | image_url: width: 360 }} 360w,{%- endif -%}
              {%- if card_product.featured_media.width >= 533 -%}{{ card_product.featured_media | image_url: width: 533 }} 533w,{%- endif -%}
              {%- if card_product.featured_media.width >= 720 -%}{{ card_product.featured_media | image_url: width: 720 }} 720w,{%- endif -%}
              {%- if card_product.featured_media.width >= 940 -%}{{ card_product.featured_media | image_url: width: 940 }} 940w,{%- endif -%}
              {%- if card_product.featured_media.width >= 1066 -%}{{ card_product.featured_media | image_url: width: 1066 }} 1066w,{%- endif -%}
              {{ card_product.featured_media | image_url }} {{ card_product.featured_media.width }}w
            "
            src="{{ card_product.featured_media | image_url: width: 533 }}"
            sizes="(min-width: {{ settings.page_width }}px) {{ settings.page_width | minus: 130 | divided_by: 4 }}px, (min-width: 990px) calc((100vw - 130px) / 4), (min-width: 750px) calc((100vw - 120px) / 3), calc((100vw - 35px) / 2)"
            alt="{{ card_product.featured_media.alt | escape }}"
            {% unless lazy_load == false %}
              loading="lazy"
            {% endunless %}
            width="{{ card_product.featured_media.width }}"
            height="{{ card_product.featured_media.height }}"
          >
          {% comment %}theme-check-enable ImgLazyLoading{% endcomment %}

        {%- else -%}
          {%- if placeholder_image -%}
            {{ placeholder_image | placeholder_svg_tag: 'placeholder-svg' }}
          {%- else -%}
            {{ 'product-apparel-2' | placeholder_svg_tag: 'placeholder-svg' }}
          {% endif %}
        {%- endif -%}

        <!-- Hover Overlay with Eye Icon -->
        <a href="{{ card_product.url }}" class="card-alternative__overlay">
          <div class="card-alternative__eye-icon">
            <svg
              version="1.1"
              xmlns="http://www.w3.org/2000/svg"
              xmlns:xlink="http://www.w3.org/1999/xlink"
              x="0px"
              y="0px"
              viewBox="0 0 512 512"
              xml:space="preserve"
            >
              <g>
                <g>
                  <path d="M510.484,251.474C447.574,168.069,354.819,120.235,256,120.235S64.425,168.07,1.515,251.474
                    c-2.02,2.679-2.02,6.371,0,9.051C64.425,343.93,157.181,391.765,256,391.765s191.574-47.834,254.484-131.239
                    C512.505,257.846,512.505,254.153,510.484,251.474z M256,376.736c-92.263,0-179.064-43.928-239.014-120.736
                    C76.936,179.192,163.737,135.264,256,135.264c92.262,0,179.063,43.928,239.014,120.736
                    C435.063,332.808,348.262,376.736,256,376.736z"></path>
                </g>
              </g>
              <g>
                <g>
                  <path d="M345.357,176.3c-2.763-3.096-7.514-3.367-10.611-0.603c-3.096,2.764-3.366,7.515-0.603,10.611
                    c17.128,19.19,26.562,43.942,26.562,69.692c0,57.734-46.971,104.704-104.705,104.704c-57.735,0-104.705-46.971-104.705-104.704
                    S198.265,151.295,256,151.295c16.904,0,33.036,3.902,47.945,11.596c3.686,1.901,8.22,0.456,10.124-3.232
                    c1.903-3.688,0.456-8.221-3.232-10.124c-16.821-8.681-35.783-13.269-54.836-13.269c-66.022,0-119.734,53.712-119.734,119.734
                    S189.978,375.734,256,375.734S375.734,322.021,375.734,256C375.734,226.552,364.945,198.248,345.357,176.3z"></path>
                </g>
              </g>
              <g>
                <g>
                  <path d="M256,208.407c-26.242,0-47.593,21.35-47.593,47.593c0,26.242,21.351,47.593,47.593,47.593s47.593-21.351,47.593-47.593
                    S282.242,208.407,256,208.407z M256,288.563c-17.955,0-32.564-14.608-32.564-32.564s14.609-32.564,32.564-32.564
                    c17.956,0,32.564,14.608,32.564,32.564S273.956,288.563,256,288.563z"></path>
                </g>
              </g>
            </svg>
          </div>
        </a>

        <!-- Badge -->
        {%- if card_product.available == false -%}
          <div class="card-alternative__badge card-alternative__badge--sold-out">
            {{ 'products.product.sold_out' | t }}
          </div>
        {%- elsif card_product.compare_at_price > card_product.price and card_product.available -%}
          {%- assign discount_percentage = card_product.compare_at_price
            | minus: card_product.price
            | times: 100
            | divided_by: card_product.compare_at_price
          -%}
          <div class="card-alternative__badge card-alternative__badge--sale">
            -{{ discount_percentage }}% {{ 'products.product.on_sale' | t }}
          </div>
        {%- endif -%}
      </div>

      <!-- Product Content -->
      <div class="card-alternative__content">
        {%- if show_vendor and card_product.vendor != blank -%}
          <div class="card-alternative__vendor">{{ card_product.vendor }}</div>
        {%- endif -%}

        <h3 class="card-alternative__title">
          <a href="{{ card_product.url }}" class="full-unstyled-link">
            {{ card_product.title | escape }}
          </a>
        </h3>

        {%- if show_rating and card_product.metafields.reviews.rating.value != blank -%}
          {% liquid
            assign rating_decimal = 0
            assign decimal = card_product.metafields.reviews.rating.value.rating | modulo: 1
            if decimal >= 0.3 and decimal <= 0.7
              assign rating_decimal = 0.5
            elsif decimal > 0.7
              assign rating_decimal = 1
            endif
          %}
          <div class="card-alternative__rating">
            <div class="card-alternative__stars">
              {%- for i in (1..5) -%}
                {%- if i <= card_product.metafields.reviews.rating.value.rating -%}
                  ★
                {%- elsif i == card_product.metafields.reviews.rating.value.rating and rating_decimal > 0 -%}
                  ☆
                {%- else -%}
                  ☆
                {%- endif -%}
              {%- endfor -%}
            </div>
            <span class="card-alternative__rating-text"> ({{ card_product.metafields.reviews.rating_count }}) </span>
          </div>
        {%- endif -%}

        <!-- Price -->
        <div class="card-alternative__price">
          <span class="card-alternative__price-current">
            {{ card_product.price | money }}
          </span>
          {%- if card_product.compare_at_price > card_product.price -%}
            <span class="card-alternative__price-compare">
              {{ card_product.compare_at_price | money }}
            </span>
          {%- endif -%}
        </div>

        <!-- Add to Cart Button -->
        <product-form data-section-id="{{ section_id }}">
          <form
            action="{{ routes.cart_add_url }}"
            method="post"
            enctype="multipart/form-data"
            id="product-form-{{ card_product.id }}"
            class="form"
            data-type="add-to-cart-form"
          >
            <input type="hidden" name="id" value="{{ card_product.selected_or_first_available_variant.id }}">
            <button
              type="submit"
              class="card-alternative__add-to-cart"
              {% unless card_product.selected_or_first_available_variant.available %}
                disabled
              {% endunless %}
              onclick="addToCart(event, '{{ card_product.id }}')"
            >
              <span class="loading-spinner"></span>
              {%- if card_product.selected_or_first_available_variant.available -%}
                Add to cart
              {%- else -%}
                Sold out
              {%- endif -%}
            </button>
          </form>
        </product-form>
      </div>
    </div>
  </div>

{%- else -%}
  <!-- Placeholder Card -->
  <div class="card-wrapper product-card-wrapper">
    <div class="card-alternative">
      <div class="card-alternative__media">
        {%- if placeholder_image -%}
          {{ placeholder_image | placeholder_svg_tag: 'placeholder-svg' }}
        {%- else -%}
          {{ 'product-apparel-2' | placeholder_svg_tag: 'placeholder-svg' }}
        {% endif %}
      </div>
      <div class="card-alternative__content">
        {%- if show_vendor -%}
          <div class="card-alternative__vendor">{{ 'products.product.vendor' | t }}</div>
        {%- endif -%}
        <h3 class="card-alternative__title">
          <a role="link" aria-disabled="true" class="full-unstyled-link">
            {{ 'onboarding.product_title' | t }}
          </a>
        </h3>
        <div class="card-alternative__price">
          <span class="card-alternative__price-current">{{ 1999 | money }}</span>
        </div>
        <button class="card-alternative__add-to-cart" disabled>Add to cart</button>
      </div>
    </div>
  </div>
{%- endif -%}

{%- unless skip_styles -%}
  <script>
    if (typeof addToCart === 'undefined') {
      function addToCart(event, productId) {
        event.preventDefault();
        const form = event.target.closest('form');
        const button = event.target;

        // Show loading state
        button.classList.add('loading');
        button.disabled = true;

        // Prepare form data
        const formData = new FormData(form);

        // Add to cart
        fetch('{{ routes.cart_add_url }}.js', {
          method: 'POST',
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            // Update cart count if element exists
            const cartCount = document.querySelector('.cart-count-bubble');
            if (cartCount) {
              fetch('{{ routes.cart_url }}.js')
                .then((response) => response.json())
                .then((cart) => {
                  cartCount.textContent = cart.item_count;
                });
            }
          })
          .catch((error) => {
            console.error('Error:', error);
          })
          .finally(() => {
            // Reset button state
            button.classList.remove('loading');
            button.disabled = false;
          });
      }
    }
  </script>
{%- endunless -%}
